// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Схема базы данных для каталога скупки радиодеталей и лома драгметаллов

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Глобальные настройки (Singleton — всегда одна запись)
// Содержит коэффициент наценки для всех товаров и контактные данные
model GlobalSettings {
  id          String   @id @default("global") // Фиксированный ID для единственной записи
  priceMarkup Float    @default(1.0) // Глобальный коэффициент наценки (например, 1.15 = +15%)
  updatedAt   DateTime @updatedAt

  // Контактные данные
  phoneNumber      String @default("") // Контактный телефон
  email            String @default("") // Почта
  telegramUsername String @default("") // Никнейм или ссылка на Telegram
  address          String @default("") // Адрес офиса
  workSchedule     String @default("") // Режим работы

  @@map("global_settings")
}

// Модель для хранения текущих курсов металлов
// В системе всегда должна быть только одна активная запись
model MetalRate {
  id        String   @id @default("current") // Используем фиксированный ID для единственной записи
  gold      Decimal  @db.Decimal(12, 4) // Цена золота за 1 грамм (руб)
  silver    Decimal  @db.Decimal(12, 4) // Цена серебра за 1 грамм (руб)
  platinum  Decimal  @db.Decimal(12, 4) // Цена платины за 1 грамм (руб)
  palladium Decimal  @db.Decimal(12, 4) // Цена палладия за 1 грамм (руб)
  updatedAt DateTime @updatedAt

  @@map("metal_rates")
}

// Модель категории с древовидной структурой (self-referencing)
model Category {
  id             String  @id @default(cuid())
  name           String
  slug           String  @unique
  parentId       String?
  sortOrder      Int     @default(0) // Поле для ручной сортировки (меньше = выше)
  warningMessage String? @db.Text // Информационное предупреждение для категории (отображается на странице каталога)

  // Закрепить управление курсом на Дашборде
  isPinnedToDashboard Boolean @default(false)

  // Кастомные курсы металлов для категории (если не заданы — используются глобальные)
  customRateAu Float? // Курс золота для этой категории (руб/г)
  customRateAg Float? // Курс серебра для этой категории (руб/г)
  customRatePt Float? // Курс платины для этой категории (руб/г)
  customRatePd Float? // Курс палладия для этой категории (руб/г)

  // Связи для древовидной структуры
  parent   Category?  @relation("CategoryTree", fields: [parentId], references: [id], onDelete: SetNull)
  children Category[] @relation("CategoryTree")

  // Связь с товарами
  products Product[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([parentId])
  @@map("categories")
}

// Единица измерения товара
enum UnitType {
  PIECE // Штука (шт)
  GRAM  // Грамм (г)
  KG    // Килограмм (кг)
}

// Модель товара (радиодеталь)
model Product {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?  @db.Text // Краткое описание товара (2-3 предложения)
  image       String?  // URL изображения
  categoryId  String
  sortOrder   Int      @default(0) // Поле для ручной сортировки (меньше = выше)
  unitType    UnitType @default(PIECE) // Единица измерения (PIECE = шт, GRAM = г, KG = кг)

  // Наценка на товар (коэффициент: 0.9 = -10%, 1.0 = без наценки, 1.15 = +15%)
  priceMarkup  Float   @default(1.0)
  // Тип товара: true = одна цена (без разделения Новое/Б/У), false = две цены
  isSingleType Boolean @default(false)

  // Содержание металлов в граммах для НОВЫХ товаров
  contentGold      Decimal @default(0) @db.Decimal(14, 6) // до 0.000001 г
  contentSilver    Decimal @default(0) @db.Decimal(14, 6)
  contentPlatinum  Decimal @default(0) @db.Decimal(14, 6)
  contentPalladium Decimal @default(0) @db.Decimal(14, 6)

  // Содержание металлов в граммах для Б/У товаров (меньше из-за скушенных ножек и т.д.)
  contentGoldUsed      Decimal @default(0) @db.Decimal(14, 6)
  contentSilverUsed    Decimal @default(0) @db.Decimal(14, 6)
  contentPlatinumUsed  Decimal @default(0) @db.Decimal(14, 6)
  contentPalladiumUsed Decimal @default(0) @db.Decimal(14, 6)

  // Настройки доступности по состоянию (Новое / Б/У)
  isNewAvailable  Boolean @default(true) // Принимаем "Новое"
  isUsedAvailable Boolean @default(true) // Принимаем "Б/У"

  // Ручные цены для каждого состояния (если нужно перебить расчетную формулу)
  manualPriceNew  Decimal? @db.Decimal(12, 2) // Фиксированная цена для "Нового"
  manualPriceUsed Decimal? @db.Decimal(12, 2) // Фиксированная цена для "Б/У"

  // Связь с категорией
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([categoryId])
  @@index([slug])
  @@map("products")
}

